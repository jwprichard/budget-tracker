// Prisma Schema for Budget Tracker

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Authentication and user management
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hashed (12 rounds)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts        Account[]
  transactions    Transaction[]
  categories      Category[]
  bankConnections BankConnection[]

  @@index([email])
  @@map("users")
}

// Enums for Account and Transaction models
enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  CASH
  INVESTMENT
  OTHER
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum TransactionStatus {
  PENDING
  CLEARED
  RECONCILED
}

// Account model - Represents financial accounts (checking, savings, credit cards, etc.)
model Account {
  id              String       @id @default(uuid())
  userId          String
  name            String
  type            AccountType
  category        String?      // Custom categorization (e.g., "Personal", "Business")
  currency        String       @default("USD")
  initialBalance  Decimal      @db.Decimal(15, 2)
  isActive        Boolean      @default(true)

  // Bank sync fields
  isLinkedToBank  Boolean      @default(false)
  lastBankSync    DateTime?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions         Transaction[]  @relation("AccountTransactions")
  transferTransactions Transaction[]  @relation("TransferDestination")
  linkedAccount        LinkedAccount? // One-to-one with external account

  @@index([userId])
  @@index([isActive])
  @@index([createdAt])
}

// Category model - Represents transaction categories with hierarchical structure
model Category {
  id          String    @id @default(uuid())
  userId      String?   // Nullable for system categories
  name        String
  color       String    @default("#757575")  // Hex color code
  icon        String?                         // Optional Material-UI icon name
  parentId    String?                         // Self-referential for hierarchy
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user          User?                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent        Category?                 @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children      Category[]                @relation("CategoryHierarchy")
  transactions  Transaction[]
  akahuMappings AkahuCategoryMapping[]    // Akahu category mappings

  @@index([userId])
  @@index([parentId])
  @@index([name])
}

// AkahuCategoryMapping - Maps Akahu bank categories to local categories
model AkahuCategoryMapping {
  id              String   @id @default(uuid())
  akahuCategory   String   @unique  // e.g., "groceries", "restaurants"
  localCategoryId String
  confidence      Int      @default(80)  // 0-100 confidence score
  isSystemDefault Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  localCategory   Category @relation(fields: [localCategoryId], references: [id], onDelete: Restrict)

  @@index([akahuCategory])
  @@map("akahu_category_mappings")
}

// Transaction model - Represents income, expenses, and transfers
model Transaction {
  id              String            @id @default(uuid())
  userId          String
  accountId       String
  categoryId      String?           // Nullable - links to Category
  type            TransactionType
  amount          Decimal           @db.Decimal(15, 2)
  date            DateTime
  description     String
  merchant        String?           // Merchant name from bank
  notes           String?
  status          TransactionStatus @default(CLEARED)
  transferToAccountId String?       // Links to destination account for transfers

  // Bank sync field
  isFromBank      Boolean           @default(false)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  account            Account              @relation("AccountTransactions", fields: [accountId], references: [id], onDelete: Cascade)
  category           Category?            @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  transferAccount    Account?             @relation("TransferDestination", fields: [transferToAccountId], references: [id], onDelete: SetNull)
  externalTransaction ExternalTransaction? // One-to-one with external transaction

  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([date])
  @@index([type])
  @@index([status])
  @@index([transferToAccountId])
}

// ============================================================================
// Bank Synchronization Models
// ============================================================================

// BankConnection - Stores connection to banking provider (Akahu, Plaid, etc.)
model BankConnection {
  id              String    @id @default(uuid())
  userId          String
  provider        String    @default("AKAHU_PERSONAL") // AKAHU_PERSONAL, AKAHU_OAUTH, PLAID, etc.
  status          String    @default("ACTIVE") // ACTIVE, INACTIVE, ERROR
  lastSync        DateTime?
  lastError       String?

  // Personal App fields (used now)
  appToken        String?   @db.Text // Encrypted, nullable for future OAuth
  userToken       String?   @db.Text // Encrypted, for Personal App user access token

  // OAuth fields (not used now, ready for future)
  accessToken     String?   @db.Text // Encrypted, null for personal app
  refreshToken    String?   @db.Text // Encrypted, null for personal app
  tokenExpiry     DateTime? // null for personal app

  metadata        Json?     // Flexible storage for provider-specific data
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedAccounts  LinkedAccount[]
  syncHistory     SyncHistory[]

  @@index([userId])
  @@index([provider])
  @@index([status])
}

// LinkedAccount - External account linked to local Account
model LinkedAccount {
  id                String    @id @default(uuid())
  connectionId      String

  // External provider data
  externalAccountId String    // Provider's account ID (e.g., Akahu's _id)
  externalName      String    // Account name from provider
  externalType      String    // BANK, CARD, etc.
  institution       String    // Bank name
  accountNumber     String?   // Masked account number

  // Link to local account
  localAccountId    String?   @unique

  // Sync control
  syncEnabled       Boolean   @default(true)
  status            String?   // Account status: ACTIVE, CLOSED, DORMANT, ERROR
  lastSync          DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  connection        BankConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  localAccount      Account?       @relation(fields: [localAccountId], references: [id], onDelete: SetNull)
  externalTransactions ExternalTransaction[]

  @@unique([connectionId, externalAccountId])
  @@index([connectionId])
  @@index([externalAccountId])
  @@index([localAccountId])
  @@index([syncEnabled])
}

// ExternalTransaction - Transaction from banking provider
model ExternalTransaction {
  id                  String    @id @default(uuid())
  linkedAccountId     String

  // External provider data
  externalTransactionId String  @unique // Provider's transaction ID
  date                DateTime
  amount              Decimal   @db.Decimal(15, 2)
  description         String
  merchant            String?
  category            String?   // Provider's category
  type                String    // Provider's type (DEBIT, CREDIT, etc.)
  balance             Decimal?  @db.Decimal(15, 2)

  // Link to local transaction
  localTransactionId  String?   @unique

  // Duplicate detection
  isDuplicate         Boolean   @default(false)
  duplicateConfidence Int?      // 0-100
  needsReview         Boolean   @default(false)

  // Raw data for debugging
  rawData             Json?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  linkedAccount       LinkedAccount @relation(fields: [linkedAccountId], references: [id], onDelete: Cascade)
  localTransaction    Transaction?  @relation(fields: [localTransactionId], references: [id], onDelete: SetNull)

  @@index([linkedAccountId])
  @@index([externalTransactionId])
  @@index([localTransactionId])
  @@index([date])
  @@index([isDuplicate])
  @@index([needsReview])
}

// SyncHistory - Track sync job history and status
model SyncHistory {
  id                  String    @id @default(uuid())
  connectionId        String
  type                String    // FULL, INCREMENTAL, MANUAL
  status              String    // PENDING, IN_PROGRESS, COMPLETED, FAILED

  startedAt           DateTime  @default(now())
  completedAt         DateTime?

  // Results
  accountsSynced      Int       @default(0)
  transactionsFetched Int       @default(0)
  transactionsImported Int      @default(0)
  duplicatesDetected  Int       @default(0)
  needsReview         Int       @default(0)

  errorMessage        String?
  errorDetails        Json?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  connection          BankConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([status])
  @@index([startedAt])
}
